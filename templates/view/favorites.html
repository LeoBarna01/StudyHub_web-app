{% extends 'main/base.html' %}
{% block title %}Your Favorites – StudyHub{% endblock %}

{% block content %}
<div class="container py-5 d-flex flex-column flex-grow-1">
    <h2 class="mb-4 text-center">Your Favorite Documents</h2>
    <div class="row g-4" id="yourFavoritesList">
        {% if favorites %}
            {% for doc in favorites %}
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <strong>{{ doc.title }}</strong><br>
                                    <small class="text-muted">
                                        {{ doc.course }}{% if doc.institute %} @ {{ doc.institute }}{% endif %}{% if doc.year %}, {{ doc.year }}{% endif %}
                                        {% if doc.subject %} • {{ doc.subject }}{% endif %}
                                        {% if doc.author %} • Uploaded by {{ doc.author.first_name }} {{ doc.author.last_name }}{% endif %}
                                        {% if doc.category %} • {{ doc.category.name }}{% endif %}
                                    </small>
                                </div>
                                <div class="col-md-4 d-flex flex-column align-items-end justify-content-center">
                                    <div class="d-flex gap-2 mt-2 mt-md-0">
                                        <button class="btn btn-sm btn-outline-secondary preview-button" data-doc-id="{{ doc.id }}">Preview</button>
                                        <button class="btn btn-sm btn-outline-secondary favorite-button favorited" data-doc-id="{{ doc.id }}" title="Remove from favorites"><i class="fas fa-star"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="col-12">
                <div class="card h-100">
                    <div class="card-body text-muted text-center">
                        No favorite documents yet.
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Document Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title w-100 text-center" id="previewModalLabel">Document Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="embed-responsive embed-responsive-16by9">
          <iframe id="documentPreviewFrame" class="embed-responsive-item" style="width: 100%; height: 500px;" src="" frameborder="0" allowfullscreen></iframe>
        </div>
         <p class="text-muted mt-3 text-center">If the preview is not working, try downloading the document.</p>
      </div>
       <div class="modal-footer d-flex justify-content-between">
            <div class="w-100 text-center">
                <button type="button" class="btn btn-secondary" id="fullscreenButton">Full Screen</button>
            </div>
            <a href="#" id="previewDownloadButton" class="btn btn-primary position-absolute end-0 me-3">Download</a>
        </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function attachFavoriteListeners() {
    document.querySelectorAll('.favorite-button, .add-to-favorites-button').forEach(button => {
        button.replaceWith(button.cloneNode(true));
    });
    document.querySelectorAll('.favorite-button, .add-to-favorites-button').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const docId = this.dataset.docId;
            fetch(`/view/toggle_favorite/${docId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(() => {
                updateFavoritesList();
            })
            .catch(error => {
                console.error('Error toggling favorite:', error);
            });
        });
    });
}

function attachPreviewListeners() {
    const previewButtons = document.querySelectorAll('.preview-button');
    const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
    const previewFrame = document.getElementById('documentPreviewFrame');
    previewButtons.forEach(button => {
        button.addEventListener('click', function() {
            const docId = this.dataset.docId;
            const previewUrl = `/view/preview/${docId}`;
            previewFrame.src = previewUrl;
            previewModal.show();
        });
    });
    document.getElementById('previewModal').addEventListener('hidden.bs.modal', function () {
        previewFrame.src = '';
    });
}

function updateFavoritesList() {
    fetch('/view/api/favorites')
        .then(response => response.json())
        .then(favorites => {
            const favoritesList = document.getElementById('yourFavoritesList');
            if (!favoritesList) return;
            favoritesList.innerHTML = '';
            if (favorites.length === 0) {
                favoritesList.innerHTML = `<div class="col-12">
                    <div class="card h-100">
                        <div class="card-body text-muted text-center">
                            No favorite documents yet.
                        </div>
                    </div>
                </div>`;
                return;
            }
            favorites.forEach(doc => {
                const card = document.createElement('div');
                card.className = 'col-md-6';
                card.innerHTML = `
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <strong>${doc.title}</strong><br>
                                    <small class="text-muted">
                                        ${doc.course || ''}${doc.institute ? ' @ ' + doc.institute : ''}
                                        ${doc.subject ? ' • ' + doc.subject : ''}
                                        ${doc.author ? ' • Uploaded by ' + doc.author : ''}
                                        ${doc.category ? ' • ' + doc.category : ''}
                                        • ${doc.downloads} downloads
                                    </small>
                                </div>
                                <div class="col-md-4 d-flex flex-column align-items-end justify-content-center">
                                    <div class="d-flex gap-2 mt-2 mt-md-0">
                                        <button class="btn btn-sm btn-outline-secondary preview-button" data-doc-id="${doc.id}">Preview</button>
                                        <button class="btn btn-sm btn-outline-secondary favorite-button favorited" data-doc-id="${doc.id}" title="Remove from favorites"><i class="fas fa-star"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                favoritesList.appendChild(card);
            });
            attachFavoriteListeners();
            attachPreviewListeners();
        })
        .catch(error => {
            console.error('Error fetching favorites:', error);
        });
}

document.addEventListener('DOMContentLoaded', function() {
    attachFavoriteListeners();
    attachPreviewListeners();
});
</script>
{% endblock %} 